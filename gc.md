# 新函数式编程语言 WASM 运行时架构设计 (v4.2)

**版本**: 4.2 (Triple-Config, Expanded Types)
**核心哲学**: 纯函数式, 隐式值语义, Perceus 优化, WASM 32位环境

---

## 1. 核心设计：FBIP (Functional But In-Place)
*   **确定性引用计数 (RC)**: 编译器自动插入 `inc/dec`，实现确定性内存释放。
*   **Perceus 算法**: 检测到 `RC == 1` 时执行原地修改，使函数式代码达到命令式性能。
*   **混合元数据**: 分配元数据 (外置位图) + 对象元数据 (内置头部)。

---

## 2. 内存布局 (64KB WASM Page 适配)
*   每个 64KB WASM 块切分为 **16 个 4KB 页**。
*   **开销**: 采用外置描述符管理，数据页内 0 Header，整体管理开销仅 0.39%。

---

## 3. 对象头配置与 TypeID 语义

### 3.1 对象头配置 (Slot Meta)

| 字段 | 类型 | 配置 A (极简型) | 配置 B (紧凑型) | 配置 C (标准型) |
| :--- | :--- | :--- | :--- | :--- |
| **RC** | 引用计数 | **u8 (1B)** | **u16 (2B)** | **u32 (4B)** |
| **TypeID** | 类型索引 | **u8 (1B)** | **u16 (2B)** | **u32 (4B)** |
| **Total Meta**| - | **2 Bytes** | **4 Bytes** | **8 Bytes** |
| **引用上限** | - | 255 (饱和则永生) | 6.5 万 | 40 亿 |
| **类型上限** | - | 255 种 | 6.5 万种 | 40 亿种 |

### 3.2 TypeID 的语义职责
`TypeID` 是运行时的核心索引，用于指导底层操作：
*   **递归释放**: 查找该类型的字段布局，递归执行 `dec_ref`。支持 `Struct`, `Tuple`, `Union`, `Array`。
*   **结构共享**: 在 `Array` (HAMT) 中区分内部节点与叶子节点。
*   **多态分发**: 索引静态生成的 VTable (包含 `clone`, `drop`, `eq` 等函数指针)。

---

## 4. 全规格规格表 (4KB 页面对比)


### 4.1 配置 A：极简型 (Meta=2B, 极致内存压缩)
| Slot 大小 | N (格数) | 净荷 (Payload) | 页尾浪费 | 净利用率 | 典型用途 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **8 B** | 512 | **6 B** | 0 B | 75.0% | 极小索引/值 |
| 12 B | 341 | **10 B** | 4 B | 83.3% | - |
| **16 B** | 256 | **14 B** | 0 B | 87.5% | 标准 Cons Cell |
| 20 B | 204 | **18 B** | 16 B | 89.6% | - |
| 24 B | 170 | **22 B** | 16 B | 91.3% | - |
| **32 B** | 128 | **30 B** | 0 B | 93.8% | HAMT 节点 / Record |
| 40 B | 102 | **38 B** | 16 B | 94.6% | - |
| 48 B | 85 | **46 B** | 16 B | 95.5% | - |
| 56 B | 73 | **54 B** | 8 B | 96.2% | - |
| **64 B** | 64 | **62 B** | 0 B | 96.9% | 闭包 / 黄金对齐 |
| 72 B | 56 | **70 B** | 64 B | 95.7% | - |
| 80 B | 51 | **78 B** | 16 B | 97.1% | - |
| 96 B | 42 | **94 B** | 64 B | 96.4% | - |
| 112 B | 36 | **110 B** | 64 B | 96.7% | - |
| **128 B** | 32 | **126 B** | 0 B | 98.4% | - |
| 144 B | 28 | **142 B** | 64 B | 97.1% | - |
| 160 B | 25 | **158 B** | 96 B | 96.4% | - |
| 192 B | 21 | **190 B** | 64 B | 97.4% | - |
| 224 B | 18 | **222 B** | 64 B | 97.6% | - |
| **256 B** | 16 | **254 B** | 0 B | 99.2% | - |
| 320 B | 12 | **318 B** | 256 B | 93.2% | - |
| 384 B | 10 | **382 B** | 256 B | 93.3% | - |
| 448 B | 9 | **446 B** | 64 B | 98.0% | - |
| **512 B** | 8 | **510 B** | 0 B | 99.6% | - |
| 768 B | 5 | **766 B** | 256 B | 93.5% | - |
| **1024 B** | 4 | **1022 B** | 0 B | 99.8% | - |

### 4.2 配置 B：紧凑型 (Meta=4B, 资源受限环境)
| Slot 大小 | N (格数) | 净荷 (Payload) | 页尾浪费 | 净利用率 | 典型用途 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **8 B** | 512 | **4 B** | 0 B | 50.0% | 极小索引/值 |
| 12 B | 341 | **8 B** | 4 B | 66.6% | - |
| **16 B** | 256 | **12 B** | 0 B | 75.0% | 标准 Cons Cell |
| 20 B | 204 | **16 B** | 16 B | 79.7% | - |
| 24 B | 170 | **20 B** | 16 B | 83.0% | - |
| **32 B** | 128 | **28 B** | 0 B | 87.5% | HAMT 节点 / Record |
| 40 B | 102 | **36 B** | 16 B | 89.6% | - |
| 48 B | 85 | **44 B** | 16 B | 91.3% | - |
| 56 B | 73 | **52 B** | 8 B | 92.7% | - |
| **64 B** | 64 | **60 B** | 0 B | 93.8% | 闭包 / 黄金对齐 |
| 72 B | 56 | **68 B** | 64 B | 93.0% | - |
| 80 B | 51 | **76 B** | 16 B | 94.6% | - |
| 96 B | 42 | **92 B** | 64 B | 94.3% | - |
| 112 B | 36 | **108 B** | 64 B | 94.9% | - |
| **128 B** | 32 | **124 B** | 0 B | 96.9% | - |
| 144 B | 28 | **140 B** | 64 B | 95.7% | - |
| 160 B | 25 | **156 B** | 96 B | 95.2% | - |
| 192 B | 21 | **188 B** | 64 B | 96.4% | - |
| 224 B | 18 | **220 B** | 64 B | 96.7% | - |
| **256 B** | 16 | **252 B** | 0 B | 98.4% | - |
| 320 B | 12 | **316 B** | 256 B | 92.6% | - |
| 384 B | 10 | **380 B** | 256 B | 92.8% | - |
| 448 B | 9 | **444 B** | 64 B | 97.6% | - |
| **512 B** | 8 | **508 B** | 0 B | 99.2% | - |
| 768 B | 5 | **764 B** | 256 B | 93.3% | - |
| **1024 B** | 4 | **1020 B** | 0 B | 99.6% | - |

### 4.3 配置 C：标准型 (Meta=8B, 工业级安全/对齐规格)
| Slot 大小 | N (格数) | 净荷 (Payload) | 页尾浪费 | 净利用率 | 典型用途 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 12 B | 341 | **4 B** | 4 B | 33.3% | - |
| **16 B** | 256 | **8 B** | 0 B | 50.0% | 标准 Cons Cell |
| 20 B | 204 | **12 B** | 16 B | 59.8% | - |
| 24 B | 170 | **16 B** | 16 B | 66.4% | - |
| **32 B** | 128 | **24 B** | 0 B | 75.0% | HAMT 节点 / Record |
| 40 B | 102 | **32 B** | 16 B | 79.7% | - |
| 48 B | 85 | **40 B** | 16 B | 83.0% | - |
| 56 B | 73 | **48 B** | 8 B | 85.5% | - |
| **64 B** | 64 | **56 B** | 0 B | 87.5% | 闭包 / 黄金对齐 |
| 72 B | 56 | **64 B** | 64 B | 87.5% | - |
| 80 B | 51 | **72 B** | 16 B | 89.6% | - |
| 96 B | 42 | **88 B** | 64 B | 90.2% | - |
| 112 B | 36 | **104 B** | 64 B | 91.4% | - |
| **128 B** | 32 | **120 B** | 0 B | 93.8% | - |
| 144 B | 28 | **136 B** | 64 B | 93.0% | - |
| 160 B | 25 | **152 B** | 96 B | 92.8% | - |
| 192 B | 21 | **184 B** | 64 B | 94.3% | - |
| 224 B | 18 | **216 B** | 64 B | 94.9% | - |
| **256 B** | 16 | **248 B** | 0 B | 96.9% | - |
| 320 B | 12 | **312 B** | 256 B | 91.4% | - |
| 384 B | 10 | **376 B** | 256 B | 91.8% | - |
| 448 B | 9 | **440 B** | 64 B | 96.7% | - |
| **512 B** | 8 | **504 B** | 0 B | 98.4% | - |
| 768 B | 5 | **760 B** | 256 B | 92.8% | - |
| **1024 B** | 4 | **1016 B** | 0 B | 99.2% | - |

---

## 5. 结论
*   **配置 A**: 使 **8B Slot** 变得可用 (6B Payload)，极大优化了简单链表和极小 Value 的存储。注意 RC=255 时进入饱和状态。
*   **配置 B**: **平衡之选**。16B Slot 拥有 12B Payload (75% 效率)，足以支撑绝大多数函数式数据结构。
*   **配置 C**: **性能之选**。8字节天然对齐，完美支持原子操作，适合大型系统。

