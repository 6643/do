# 内存管理深度对比：自研 GC (Perceus + RC) vs 宿主 GC (Wasm GC)

本规范对 `do` 语言采用的自研确定性内存管理方案与 WebAssembly 官方引用类型 (GC) 方案进行深维度对比。

## 1. 核心设计哲学

| 特性 | 自研方案 (Perceus + RC) | 宿主方案 (Wasm GC) |
| :--- | :--- | :--- |
| **理论基础** | 值语义 + 引用计数 (Deterministic RC) | 引用语义 + 追踪式回收 (Tracing GC) |
| **主导思想** | **FBIP** (Functional But In-Place)。逻辑上不可变，物理上尽可能原地修改。 | 基于对象生命周期的自动回收。 |
| **内存物理层** | 自主控制 Wasm Linear Memory (4KB 分页)。 | 宿主引擎 (V8/SM) 托管堆。 |

## 2. 深度技术对比

### 2.1 性能与开销 (Performance)
*   **自研 (Perceus)**:
    *   **优势**: 极致的空间局部性。Perceus 分析能在代码运行前确定对象的最后使用点。若此时引用计数为 1，直接原地复用内存，避免分配与拷贝。
    *   **劣势**: 每次赋值/传递需要原子/普通 RC 增减开销（虽可通过编译器优化部分抵消）。
*   **宿主 (Wasm GC)**:
    *   **优势**: 分配速度极快（通常是 Bump Allocation）。不需要在每个操作中插入 RC 计算。
    *   **劣势**: GC 触发时存在非确定性的暂停 (Stop-the-world)，且由于对象对 Wasm 线性内存透明，跨内存边界（如处理原始字节流）存在转换成本。

### 2.2 确定性与延迟 (Determinism)
*   **自研方案**: **完全确定**。内存释放紧跟在最后一个引用失效之后。不存在 GC 抖动，非常适合高性能实时渲染或高频率计算场景。
*   **宿主方案**: **非确定**。由宿主引擎决定何时回收内存。对长耗时任务或内存敏感型应用，这种不确定性可能导致突发的帧率抖动。

### 2.3 物理布局与优化 (Memory Layout)
*   **自研方案**: 
    *   **扁平化**: 结构体直接嵌入。
    *   **Slot 压缩**: 针对每种类型动态收缩元数据（如 u8 记录 RC）。
    *   **Cache Friendly**: 对象在 4KB 页面内物理对齐。
*   **宿主方案**: 
    *   对象对于 Wasm 代码是“不透明”的句柄。
    *   无法确切控制对象在内存中的具体位置（由宿主决定），难以针对硬件缓存 (L1/L2) 进行手动布局优化。

### 2.4 交互性 (Interoperability)
*   **自研方案**: 
    *   需要显式的序列化/反序列化（或桥接代码）才能与 JavaScript/Host 共享复杂对象。
*   **宿主方案**: 
    *   原生支持。Wasm GC 对象可以直接映射给宿主环境，减少了跨边界调用的性能开销。

## 3. 为什么 `do` 语言选择自研路线？

1.  **FBIP 优化的极致实现**: 宿主 GC 无法理解 `do` 语言的值语义意图，因此无法自动将 `set(user, ...)` 转化为 CPU 指令级的 `store`。只有自研 RC + 编译器感知才能实现真正的零拷贝变异。
2.  **全平台一致性**: 自研方案仅依赖基础的 Wasm Linear Memory，不要求宿主环境必须支持实验性的 Wasm GC 提案。
3.  **内存占用可控性**: 宿主 GC 通常倾向于占用更多内存以减少回收频率，而自研方案在对象失效瞬间即回收，内存占用波峰更低、更平滑。

## 4. 总结

| 维度 | 自研方案 (do) | 宿主方案 (Wasm GC) |
| :--- | :--- | :--- |
| **突发暂停 (GC Pause)** | **无** | 有 (由宿主决定) |
| **内存复用** | **高 (原地修改)** | 低 (产生新对象等待回收) |
| **控制力** | **全权掌控 (Slot/Page)** | 抽象托管 |
| **实现难度** | 极高 (由于需处理引用循环与 Perceus 算法) | 低 (利用现有基础设施) |

> [!NOTE]
> `do` 语言的自研方案更像是一种“编译时决定的内存管理”，通过在编译阶段注入精确的回收与原地修改逻辑，换取运行时的确定性与峰值性能。
